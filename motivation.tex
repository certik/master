\section{Formulation of the Schr\"odinger Equation for Finite Element Method}

Our ultimate goal is to be able to calculate large electron structure problems
using density functional theory, pseudopotentials and finite element method.
That's a very difficult problem, that people only very recently started to
tackle \cite{pask1, pask2, ortiz1, ortiz2}.

In order to get there, we need to decompose the whole problem into smaller
tasks, build robust solvers for smaller tasks and then use them like a child
assembly game. The two most important steps are the following.

One ingredient is a working density functional theory solver. This will be
described in a next section and results presented in the Result's section.

Another ingredient is a robust finite element solver for a one particle
Schr\"odinger equation. We wrote a very general solver that works both in 2D
and 3D and can solve the eigenproblem for any potential accurately and
reliably. We calculated many well known solution in 2D and 3D (for spherically
symmetric problems) and checked with analytical solution to be sure the solver
works well. We then also calculated a couple nonsymmetric problems in 2D to
show the usefulness of our solver -- those are unique results that are quite
difficult to get using other means -- our solver solves symmetric and
nonsymmetric problems with ease.

\subsection{Weak Formulation}

One particle Schr√∂dinger equation is 
\begin{equation*}
  \left(-{\hbar^2\over2m}\nabla^2 + V\right)\psi=E\psi\,.
\end{equation*}
We multiply both sides by a test function $v$
\begin{equation*}
  -\left({\hbar^2\over2m}\nabla^2\psi\right)v=(E-V)\psi v\,,
\end{equation*}
and integrate over the whole volume we are interested in 
\begin{equation}
  \int-\left({\hbar^2\over2m}\nabla^2\psi\right)v\,\d V=\int(E-V)\psi v\,\d V\,,  \label{1}
\end{equation}
and using the vector identity 
\begin{equation*}
  -\left(\nabla^2\psi\right)v=\nabla \psi\cdot \nabla v - \nabla\cdot\left((\nabla \psi)v\right),
\end{equation*}
we rewrite the left hand side of (\ref{1})
\begin{equation*}
  \int{\hbar^2\over2m}\nabla\psi\cdot\nabla v\,\d V=\int(E-V)\psi v\,\d V+\int{\hbar^2\over2m}\nabla\cdot\left((\nabla \psi)v\right)\,\d V\,,
\end{equation*}
now we apply Gauss Theorem 
\begin{equation*}
  \int{\hbar^2\over2m}\nabla\psi\cdot\nabla v\,\d V=\int(E-V)\psi v\,\d V+\oint{\hbar^2\over2m}(\nabla \psi)v\cdot{\bf n}\,\d S\,,
\end{equation*}
and rewriting $\nabla\psi\cdot{\bf n}\equiv{\d\psi\over\d n}$
\begin{equation}
  \int{\hbar^2\over2m}\nabla\psi\cdot\nabla v\,\d V+ \int vV\psi\,\d V = \int E\psi v\,\d V + \oint{\hbar^2\over2m}{\d\psi\over\d n}v\,\d S\,,  \label{w}
\end{equation}
which is the weak formulation. The problem reads: find a function $\psi$ such that (\ref{w}) holds for every $v$.

\subsection{Finite Elements}

We choose a basis $\phi_i$ and substitute $\phi_i$ for $v$ and expand $\psi=\sum q_j\phi_j$
\begin{equation}
  \left(\int{\hbar^2\over2m}\nabla\phi_j\cdot\nabla\phi_i\,\d V+ \int\phi_iV\phi_j\,\d V\right)q_j = \left(\int E\phi_j\phi_i\,\d V\right)q_j +\oint{\hbar^2\over2m}{\d\psi\over\d n}\phi_i\,\d S\,,  \label{fem}
\end{equation}
which can be written in a matrix form 
\begin{equation*}
  \left(K_{ij}+V_{ij}\right)q_j=EM_{ij}q_j+F_i\,,
\end{equation*}
where 
\begin{eqnarray*}
V_{ij}&=&\int\phi_iV\phi_j\,\d V\,, \\
M_{ij}&=&\int\phi_i\phi_j\,\d V\,, \\
K_{ij}&=&{\hbar^2\over2m}\int\nabla\phi_i\cdot\nabla\phi_j\,\d V\,, \\
F_i&=&{\hbar^2\over2m}\oint{\d\psi\over\d n}\phi_i\,\d S\,. \\
\end{eqnarray*}
 Usually we set $F_i=0$.

We decompose the domain into elements and compute the integrals as the sum over elements. For example: 
\begin{equation*}
  K_{ij}=\sum_{E\in elements} K_{ij}^E
\end{equation*}
where $K_{ij}^E$ is the integral over one element only 
\begin{equation*}
  K_{ij}^{E}=\int{\hbar^2\over2m}\nabla\phi_j\cdot\nabla\phi_i\,\d V^{E}\approx \sum_{q=0}^{N_q-1}{\hbar^2\over2m}\,\nabla\phi_i(x_q)\cdot\nabla\phi_j(x_q)\, w_q|\det J(\hat x_q)|\,.
\end{equation*}
The integral is computed numerically using a Gauss integration: $x_q$ are Gauss points (there are $N_q$ of them), $w_q$ is the weight of each point, and the Jacobian $|\det J(\hat x_q)|$ is there because we are actually computing the integral on the reference element instead in the real space.

The surface integrals are computed similarly.


\section{Density Functional Theory Formulation for Spherically Symmetric
Problems}

The Kohn-Sham equations (\ref{KSeq}) for spherically symmetric potential reduce
to radial Schr\"odinger (or Dirac) equations, which we integrate using the
methods described in the section 1.2.

\section{Pseudopotentials}

Ab-inito pseudopotentials \cite{pickett} considerably improve the efficiency of
electronic structure calculations of complex systems by separating (and
treating in different way) the core and valence electrons, howsoever we define
them.  Using the modern, ab-initio environment reflecting pseudopotentials
\cite{vackarAEPP2} in fact does not represent any additional approximation
except for linearizing the density functional approach with respect to
one-electron energies, which is the common approximation in all standard
existing DFT methods.  For applying pseudopotentials within the finite-element
basis set, using the separable form is necessary.

In combination with the finite element method, the pseudopotentials improve the
efficiency of complex system calculations in essential and extremely
singificant way as a consequence of several mechanisms:
\begin{itemize}

\item By treating the core electrons separately in the pseudopotential
generation process, the need to include them into the most computationaly
expensive DFT selfconsistency iterative process is eliminated.  The fact that
the core electrons do not participate in this process significantly reduces the
number of electronic states and, by that, reduces the number of eigenvectors
that have to be found in each step iteratively repeted until the eigenvectors
satisfy the DFT selfconsistency condition.

\item The relativistic effect can be taken into account just for the core
electrons with high binding energies. The separate spin-up and spin-down
pseudopotentials can be generated in the cases where taking into account the
spin-orbit coupling is desirable for valence electrons, eliminating the need to
solve Dirac equation for valence electrons by finite-element method, which
would be extremely complicated task.

\item Eliminating the high binding energies of core electrons from the DFT
selfconsistency iterative process reduces the numerical problems and improves
numerical precision.

\item Pseudopotentials eliminate high potential gradients and Coulomb potential
singularities, which significantly reduces the density of finite-element mesh
that is necesary for achieving well converged accurate results. By that, the
efficiency can be significantly improved, particularly in the tasks like
molecular dynamics calculations.

\end{itemize}
